name: Process Department Content

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate-content:
    runs-on: ubuntu-latest
    steps:
      - name: ç«‹å³å›å¤â€œå·²æ”¶åˆ°ï¼Œæ­£åœ¨å¤„ç†...â€
        id: initial-comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "âœ… å·²æ”¶åˆ°æ‚¨çš„æŠ•ç¨¿è¯·æ±‚ï¼Œæ­£åœ¨å¤„ç†...\n\nè¯·ç¨ç­‰ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å®Œæˆè§£æå¹¶ç”Ÿæˆå†…å®¹ã€‚"
            });

            // è®°å½•è¯„è®º ID ä»¥ä¾¿åç»­æ›´æ–°
            core.setOutput("comment_id", response.data.id);

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.35.1/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          pip install pyyaml

      - name: æå–æ¨¡æ¿å­—æ®µ
        id: extract-fields
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          cat > extract.py << 'EOF'
          import os, sys, re

          def extract_section(body, section_name):
              """æå–æŒ‡å®šéƒ¨åˆ†çš„å†…å®¹"""
              marker = f"### {section_name}"
              start = body.find(marker)
              if start == -1:
                  return None
              start += len(marker)
              end = body.find("###", start)
              return body[start:end].strip() if end != -1 else body[start:].strip()

          def extract_content(body):
              """æå–å†…å®¹ - ä»ç¬¬ä¸€ä¸ª```markdownåˆ°æœ€åä¸€ä¸ª```"""
              start = body.find("```markdown")
              if start == -1:
                  return None
              start = body.find("\n", start) + 1
              end = body.rfind("```")
              return body[start:end].strip() if end != -1 and end > start else None

          body = os.environ.get("ISSUE_BODY", "")
          department = extract_section(body, "éƒ¨é—¨åç§°")
          title = extract_section(body, "æ ‡é¢˜")
          filename = extract_section(body, "æ–‡ä»¶å")
          content = extract_content(body)

          if not department or not filename or not content:
              print("é”™è¯¯: ç¼ºå°‘å¿…è¦å­—æ®µ")
              sys.exit(1)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"DEPARTMENT={department}\n")
              f.write(f"FILENAME={filename}\n")
              f.write(f"CONTENT<<EOF\n{content}\nEOF\n")
          EOF
          python extract.py

      - name: åŒ¹é…éƒ¨é—¨ç›®å½•
        id: find-department
        env:
          DEPARTMENT: ${{ steps.extract-fields.outputs.DEPARTMENT }}
        run: |
          BASE_DIR="src"
          TARGET_DIR=""

          for dir in $(find $BASE_DIR -maxdepth 1 -type d); do
            readme="$dir/README.md"
            if [ -f "$readme" ]; then
              frontmatter=$(sed -n '/^---$/,/^---$/p' $readme | tail -n +2 | head -n -1)
              title=$(python -c "import yaml; print(yaml.safe_load('''$frontmatter''').get('title', ''))")
              if [ "$title" = "$DEPARTMENT" ]; then
                TARGET_DIR="${dir#*/}"
                break
              fi
            fi
          done

          if [ -z "$TARGET_DIR" ]; then
            echo "æœªæ‰¾åˆ°åŒ¹é…éƒ¨é—¨ç›®å½•ï¼"
            exit 1
          fi
          echo "target_dir=$TARGET_DIR" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆæ–‡ä»¶
        id: generate-file
        env:
          DEPARTMENT: ${{ steps.extract-fields.outputs.DEPARTMENT }}
          FILENAME: ${{ steps.extract-fields.outputs.FILENAME }}
          CONTENT: ${{ steps.extract-fields.outputs.CONTENT }}
          TARGET_DIR: ${{ steps.find-department.outputs.target_dir }}
        run: |
          CLEAN_FILENAME=$(echo "$FILENAME" | tr ' ' '-' | tr -cd '[:alnum:]-_')
          FILE_PATH="src/$TARGET_DIR/${CLEAN_FILENAME}.md"
          echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT

          echo "---" > $FILE_PATH
          echo "title: ${FILENAME}" >> $FILE_PATH
          echo "---" >> $FILE_PATH
          echo "" >> $FILE_PATH
          echo "$CONTENT" >> $FILE_PATH

      - name: åˆ›å»ºåˆ†æ”¯å¹¶æäº¤æ›´æ”¹
        id: create-branch
        env:
          FILENAME: ${{ steps.extract-fields.outputs.FILENAME }}
          FILE_PATH: ${{ steps.generate-file.outputs.file_path }}
        run: |
          BRANCH_NAME="content-update/$(date +%Y%m%d%H%M%S)"
          git checkout -b $BRANCH_NAME
          git add "$FILE_PATH"
          git commit -m "æ·»åŠ å†…å®¹: $FILENAME"
          git push --force origin $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: åˆ›å»º PR
        id: create-pr
        uses: actions/github-script@v6
        env:
          BRANCH_NAME: ${{ steps.create-branch.outputs.branch_name }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `å†…å®¹æŠ•ç¨¿: ${{ steps.extract-fields.outputs.DEPARTMENT }} - ${{ steps.extract-fields.outputs.FILENAME }}`,
              body: `ç”± Issue #${context.issue.number} è‡ªåŠ¨ç”Ÿæˆ`,
              head: process.env.BRANCH_NAME,
              base: 'main'
            });
            core.setOutput("pr_url", response.data.html_url);

      - name: æ›´æ–°è¯„è®ºä¸ºæœ€ç»ˆçŠ¶æ€
        if: always()
        uses: actions/github-script@v6
        env:
          COMMENT_ID: ${{ steps.initial-comment.outputs.comment_id }}
          FILE_PATH: ${{ steps.generate-file.outputs.file_path }}
          PR_URL: ${{ steps.create-pr.outputs.pr_url }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = process.env.COMMENT_ID;
            let updatedBody;

            if ('${{ success() }}' === 'true') {
              updatedBody = `âœ… **å¤„ç†å®Œæˆï¼**
              - ç”Ÿæˆæ–‡ä»¶: \`${process.env.FILE_PATH}\`
              - [æŸ¥çœ‹ PR](${process.env.PR_URL})\nğŸ‰ æ‚¨çš„å†…å®¹å·²æˆåŠŸæäº¤ï¼`;
            } else {
              updatedBody = `âš  **å¤„ç†å¤±è´¥ï¼** å¯èƒ½çš„é”™è¯¯åŸå› : æå–å­—æ®µå¤±è´¥ã€Git æ“ä½œå¤±è´¥ç­‰ã€‚è¯·æ£€æŸ¥ Issue æ ¼å¼ã€‚`;
            }

            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: updatedBody
            });
